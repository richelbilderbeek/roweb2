---
slug: "babette"
title: Call BEAST2 from R
package_version: 2.0
authors:
  - name: Richel J.C. Bilderbeek
    url: https://www.richelbilderbeek.nl
date: 2019-01-06
categories: blog
topicid: 
tags:
- software-peer-review
- r
- community
- software
- packages
- phylogeny
- phylogenetics
- BEAST
- BEAST2
- Bayesian
---

`babette` is a package to work with BEAST2 [1] from R.

`babette` is a spin-off of my own academic research.
As a PhD I work models of diversification: mathematical descriptions
of how species form new species. Instead of working on a species'
individuals, I work on species as evolutionary lineages.
A good way to show the evolutionary relationships between species
are phylogenies. For example, this a phylogeny, with four species,
eloquently named '1', '2', '3' and '4':

[](img/blog-images/2019-01-06-babette/phylogeny.png)

In my research, I simulate thousands of these. I call these 
phylogenies 'the truth'. Then I wonder, would such a phylogeny actually
be true, how well would we be able to infer it? I say 'infer', instead
of 'measure', as we cannot measure phylogenies directly in nature. 

In nature, however, we can sequence the DNA of species. From these DNA
sequences, we use software to neatly arrange these sequences, creating
a DNA alignment. Such DNA alignments are where most researchers start from.
Here is such an alignment, of four (eloquently named) species
and their aligned DNA sequences, in which a different color represents a
different nucleotide:

[](img/blog-images/2019-01-06-babette/alignment.png)

It is hard to only guess by eye which of the four species are most related.
Luckily, we have software for such problems, for example, BEAST2.
BEAST2 is a Bayesian phylogenetic tool that infers a posterior
from a DNA alignment. The posterior contains multiple phylogenies,
in which likelier are present more often. Here is how these
posterior trees look like when superimposed:

[](img/blog-images/2019-01-06-babette/densitree.png.png)

In my reseach, I would need thousands of posteriors. There
was a practical reason to make this go smooth.

#### Before `babette`

Before `babette` existed, it would take three steps to plot
the phylogenies in a posterior:

Step|      Input      |   Tool  |        Output
----|-----------------|---------|-----------------------
   1|alignment        |BEAUti   |BEAST2 input file
   2|BEAST2 input file|BEAST2   |posterior files
   3|posterior files  |DensiTree|plot of the phylogenies

 1. Run BEAUti to create a BEAST2 input file
 2. Run BEAST2 to create a posterior
 3. Run DensiTree to plot the phylogenies in a posterior

BEAUti (I assume the pun to BEAST is intended) is a beginner-friendly program 
with a graphical user interface. To analyse an alignment such as above,
one needs at least 7 mouse clicks or 3 keyboard commands to create
a BEAST2 input file. BEAST2 can be called from the command line to
read the input file and create a posterior saved as multiple files.
DensiTree is another beginner-friendly program with a graphical
user interface to load the phylogenies of a posterior and plot these. 

Again, I would need thousands of these posteriors.
Doing these steps manually would be a drag.
Instead, I created `babette` to work with BEAST2 from R.

#### With `babette`

We are going to reproduce the workflow described above with `babette`.
First, we'll load `babette` into memory:

```
library(babette)
```

Again, `babette` is a package to work with BEAST2 from R.
The Bayesian inference of BEAST2 works on an alignment,
stored in FASTA format. This is how such a FASTA file looks like:

```
>1
gcaagagtaacccccgccaggagtaggggcctttttcctt
>2
aacatagcaacccccgccacgtgtgggggtctttttcctt
>3
gaatcactgtcccccttcacgatggtgtgtttttatttgt
>4
taaaaaaaaagactatcgaagggggtgggggtttttcctt
```

Well spotted, this FASTA file contains the same alignment as the picture above!

Say, we have this alignment stored as a file with the 
name `alignment.fasta` in our present working directory:

```
fasta_filename <- "alignment.fasta"

# Check if it really exists
stopifnot(file.exists(fasta_filename))
```

To obtain a BEAST2 posterior with `babette`, do:

```
output <- bbt_run(
  fasta_filename = fasta_filename
)
```

And plotting the posterior trees:

```
plot_densitree(
  output$alignment_trees,
  alpha = 0.01,
  consensus = as.character(c(1:4)),
  cex = 2.0,
  scaleX = TRUE,
  scale.bar = FALSE
)
```

Note that for plotting the posterior trees, I've added many arguments to 
make it a beautiful blog post picture.




#### Spoilers

Actually, the phylogeny shown was the 'true phylogeny' underlying the alignment.








#### Adding tips via taxonomy

Tips can also be added to the tree [automatically if there are other members](https://ropensci.github.io/treeStartR/#adding-tips-with-congeners) of the same genus on the tree. The function [`present_tippr`](https://ropensci.github.io/treeStartR/#adding-tips-with-congeners)` checks the genus of a tip to be added to the tree against the genera present on the tree. If there is one match, the tip is added as a sister to its congener. If there are multiple members of the same genus, the tip is added subtending the most recent common ancestor of all members of the genus. This is a fairly handy function for adding taxa that are closely related to other tips on the tree - there's no need to make a dataframe of species relationships.

#### Adding tips at random

For when you well and truly have no idea how the taxa you want to add to your tree should be added. [`rand_absent_tippr`](https://ropensci.github.io/treeStartR/#adding-tips-at-random) will add your tips to the tree ... somewhere. In the datasets my lab works with, there are always a few fossil taxa with unclear relationships to the rest of the group. This function allows us to develop a distribution of starting positions for mysterious taxa.

#### Adding tips by hand

For the visual among us, [`absent_tippr`](https://ropensci.github.io/treeStartR/#adding-tips-at-random) opens a graphical user interface. Users can then see the computer-generated node label for every node in the tree, and choose the one they would like the added tip to subtend.


#### Mix and Match

For some of our workflows in the lab, we use multiple functions. For example, we might first place all the tips that have close relatives using `present_tippr`. Then, tips that represent more distantly related taxa can be placed via `text_placr`, and the leftover fossils added via `rand_absent_tippr`.

### Why rOpenSci

I was a little unsure at first about submitting a package to rOpenSci. 
I'm a biologist, and while I'm computational, 
the idea that I might be a solo author on an R package seemed like I was, 
I don't know, misrepresenting myself? I'm not some sort of big, serious software person. But the more I thought about it, I realized that that makes rOpenSci more attractive - that some serious people could help guide me in making this package. I want stable software for my students to learn from and use. And so I should ask for review. It's appropriate and it's good to ask for expert opinion.

When I was thinking of writing up this blog, I posed the question to Twitter:

<blockquote class="twitter-tweet" data-lang="en"><p lang="en" dir="ltr">are there other venues (outside or within traditional scientific journals) for R code review? My packages don&#39;t fall under scope of <a href="https://twitter.com/rOpenSci?ref_src=twsrc%5Etfw">@rOpenSci</a> and would probably need domain experts (plant biologists in this case)</p>&mdash; Chris Muir (@thegoodphyte) <a href="https://twitter.com/thegoodphyte/status/1067269265810698240?ref_src=twsrc%5Etfw">November 27, 2018</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>


And I hope I can answer this question adequately. I picked rOpenSci because it was explicitly R (so the editor and reviewers would know best practices) and the guidelines and how review would proceed were very clear. And for a totally new experience of in-depth code review, being able to see where the effort was collaborative was helpful. I looked at [other journals](https://joss.readthedocs.io/en/latest/submitting.html), but I liked that rOpenSci had biologists as editors. Because the handling editor ([Scott Chamberlain](https://scottchamberlain.info/)) is a biologist, he had the ability to work with me to find reviewers ([David Bapst](https://geogeo.tamu.edu/people/faculty/bapstdavidwilliam) and [Rachel Warnock](https://www.bsse.ethz.ch/cevo/the-group/people/person-detail.html?persid=215787)) who are serious experts in both R and the particular type of phylogenetics that I do. I suggested Dave & Rachel because I know I can collaborate with them, and they will be constructive and kind. But they will also really try to break the package and dig in to the meat of what software functions are required to support the science we do, and tell me honestly if my package is providing those functions. [You can see](https://github.com/ropensci/onboarding/issues/239) they weren't easy on me!

rOpenSci also has a [collaboration](https://ropensci.org/blog/2017/11/29/review-collaboration-mee/) with [Methods in Ecology and Evolution](https://besjournals.onlinelibrary.wiley.com/hub/journal/2041210X/author-guidelines). I plan to send a short software note there. It's very nice to have the flexibility to send the paper to a traditional outlet like Methods in Ecology and Evolution, or to send it to [JOSS](https://joss.theoj.org/), or to do nothing at all, if I didn't want to.

#### tl;dr



### Future

I'll likely add in more utility functions for parsing biological data for use with divergence time estimation. Particularly, I often work with [RevBayes](https://revbayes.github.io/), which is a sandbox-like framework for Bayesian analysis of phylogeny and comparative methods. Our analyses integrate across fossil taxa from databases, molecular data from the literature and stratigraphic ranges. Each data source has special and unique quirks, and I'm always looking for ways to lower the bar for undergraduate researchers to be able to access these sorts of complex modeling frameworks. Please feel free to make a pull request or file an issue if there's something you'd like to see added. I have a [Contributing](https://github.com/ropensci/treeStartR/blob/master/.github/CONTRIBUTING.md) guide here outlining how to contribute.

### Acknowledgements

Yacine Ben Chehida and Paul van Els supplied the first use cases.
The first partial review was done by Guangchuang Yu. 
Full reviews were provided by David Wright and Joëlle Barido-Sottani.
Noam Ross handled the review process. 
Raphael Scherrer and Jana Riederer already helped me spot a bug I overlooked. 

### References

 * [1] Bouckaert, R., Heled, J., Kühnert, D., Vaughan, T., Wu, C-H., Xie, D., Suchard, MA., Rambaut, A., & Drummond, A. J. (2014). BEAST 2: A Software Platform for Bayesian Evolutionary Analysis. PLoS Computational Biology, 10(4), e1003537. doi:10.1371/journal.pcbi.1003537 
